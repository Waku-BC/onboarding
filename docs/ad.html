<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CSAI Advertising Inspector</title>

<style>

:root{
  --black:#000;
  --white:#fff;
  --yellow:#EFD900;
  --orange:#F76531;
  --purple:#AA6C7E;
  --blue:#4EA9D1;

  --fg: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.64);
  --border: rgba(255,255,255,.12);

  --max: 1160px;
  --h: 72px;

  --shadow-soft: 0 8px 22px rgba(0,0,0,.22);

  --ease: cubic-bezier(.2,.8,.2,1);
  --focus: 0 0 0 3px rgba(78,169,209,.35);
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  background: var(--black);
  color: var(--fg);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Sans", "Apple Color Emoji","Segoe UI Emoji";
  overflow-x:hidden;
}
a{ color:inherit; text-decoration:none; }
button, input{ font:inherit; }

.container{
  width:min(var(--max), calc(100% - 32px));
  margin:0 auto;
}

/* ===== Header (identical) ===== */
.header{
  position:sticky; top:0; z-index:50;
  height:var(--h);
  display:flex; align-items:center;
  background: linear-gradient(to bottom, rgba(0,0,0,.78), rgba(0,0,0,.35));
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(255,255,255,.08);
  transition: background .25s var(--ease), box-shadow .25s var(--ease), border-color .25s var(--ease);
}
.header.is-scrolled{
  background: rgba(0,0,0,.84);
  box-shadow: var(--shadow-soft);
  border-bottom-color: rgba(255,255,255,.12);
}
.header-inner{
  width:min(var(--max), calc(100% - 32px));
  margin:0 auto;
  display:flex; align-items:center; justify-content:space-between;
  gap:14px;
}
.brand{ display:flex; align-items:center; gap:12px; min-width: 220px; }
.logo-img{ width:34px; height:34px; object-fit:contain; display:block; }
.brand-name{ display:flex; flex-direction:column; line-height:1.08; }
.brand-name strong{ font-weight:800; letter-spacing:.6px; }
.brand-name span{ font-size:12px; color: var(--muted); }

.nav{
  display:flex; align-items:center; gap:2px;
  padding:6px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.25);
}
.nav a{
  padding: 10px 12px;
  border-radius: 999px;
  font-size: 14px;
  color: rgba(255,255,255,.78);
  transition: background .18s var(--ease), color .18s var(--ease), transform .18s var(--ease);
  position:relative;
  outline:none;
  white-space:nowrap;
}
.nav a:hover{ background: rgba(255,255,255,.08); color: rgba(255,255,255,.92); transform: translateY(-1px); }
.nav a:focus-visible{ box-shadow: var(--focus); }
.nav a[data-active="true"]{
  color: rgba(255,255,255,.95);
  background: rgba(255,255,255,.10);
}
.nav a[data-active="true"]::after{
  content:"";
  position:absolute;
  left:16px; right:16px; bottom:6px;
  height:2px; border-radius:999px;
  background: linear-gradient(90deg, var(--yellow), var(--orange), var(--purple), var(--blue));
  opacity:.95;
}
/* ===== Nav dropdown (add-on) ===== */
.nav{ position:relative; } /* menu„ÅÆÂü∫Ê∫ñ */

.nav-dd{
  position:relative;
  display:inline-flex;
  align-items:center;
}

.nav-dd-btn{
  appearance:none;
  border:0;
  background:transparent;
  color: rgba(255,255,255,.78);
  padding: 10px 12px;
  border-radius: 999px;
  font-size: 14px;
  cursor:pointer;
  transition: background .18s var(--ease), color .18s var(--ease), transform .18s var(--ease);
  display:inline-flex;
  align-items:center;
  gap:10px;
  outline:none;
  white-space:nowrap;
  position:relative;
}
.nav-dd-btn:hover{
  background: rgba(255,255,255,.08);
  color: rgba(255,255,255,.92);
  transform: translateY(-1px);
}
.nav-dd-btn:focus-visible{ box-shadow: var(--focus); }

.nav-dd[data-open="true"] .nav-dd-btn{
  color: rgba(255,255,255,.95);
  background: rgba(255,255,255,.10);
}

/* Catalog/Advertising „Åå active „ÅÆ„Å®„ÅçÔºàÂ≠ê„Éö„Éº„Ç∏„Åß„ÇÇÔºâ */
.nav-dd[data-active="true"] .nav-dd-btn::after{
  content:"";
  position:absolute;
  left:16px; right:16px; bottom:6px;
  height:2px; border-radius:999px;
  background: linear-gradient(90deg, var(--yellow), var(--orange), var(--purple), var(--blue));
  opacity:.95;
}

.chev{
  width:10px; height:10px;
  display:inline-block;
  border-right:2px solid rgba(255,255,255,.55);
  border-bottom:2px solid rgba(255,255,255,.55);
  transform: rotate(45deg);
  transition: transform .18s var(--ease), opacity .18s var(--ease);
  opacity:.9;
}
.nav-dd[data-open="true"] .chev{
  transform: rotate(225deg);
}

/* dropdown panel */
.nav-menu{
  position:absolute;
  top: calc(100% + 10px);
  left: 0;
  min-width: 220px;
  padding: 8px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.72);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  box-shadow: 0 14px 40px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,.06) inset;
  display:none;
  z-index: 80;
}

.nav-dd[data-open="true"] .nav-menu{ display:block; }

.nav-menu a{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  padding: 10px 10px;
  border-radius: 12px;
  color: rgba(255,255,255,.86);
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.04);
  transition: transform .18s var(--ease), background .18s var(--ease), border-color .18s var(--ease);
  white-space:nowrap;
}
.nav-menu a:hover{
  transform: translateY(-1px);
  background: rgba(255,255,255,.08);
  border-color: rgba(255,255,255,.16);
}
.nav-menu a[data-active="true"]{
  background: rgba(255,255,255,.10);
  border-color: rgba(255,255,255,.18);
  position:relative;
}
.nav-menu a[data-active="true"]::after{
  content:"";
  position:absolute;
  left:12px; right:12px; bottom:7px;
  height:2px; border-radius:999px;
  background: linear-gradient(90deg, var(--yellow), var(--orange), var(--purple), var(--blue));
  opacity:.95;
}

/* Responsive: narrow screens */
@media (max-width: 760px){
  .nav{ flex-wrap:wrap; justify-content:center; }
  .nav-menu{ left: 50%; transform: translateX(-50%); }
}

/* ===== Brand gradient hover/active (add-on) ===== */
:root{
  --brand-grad: linear-gradient(90deg, var(--yellow), var(--orange), var(--purple), var(--blue));
}

/* Top-level links (Media/Player/GA etc.) */
.nav a:hover{
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.96);
}
.nav a:hover::after{
  content:"";
  position:absolute;
  left:16px; right:16px; bottom:6px;
  height:2px; border-radius:999px;
  background: var(--brand-grad);
  opacity:.95;
}

/* Dropdown trigger (Catalog/Advertising buttons) */
.nav-dd-btn:hover{
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.96);
}
.nav-dd-btn:hover::after{
  content:"";
  position:absolute;
  left:16px; right:16px; bottom:6px;
  height:2px; border-radius:999px;
  background: var(--brand-grad);
  opacity:.95;
}

/* Open state: subtle gradient "wash" + line */
.nav-dd[data-open="true"] .nav-dd-btn{
  background:
    linear-gradient(rgba(255,255,255,.08), rgba(255,255,255,.08)) padding-box,
    var(--brand-grad) border-box;
  border: 1px solid transparent;
}
.nav-dd[data-open="true"] .nav-dd-btn::after{
  content:"";
  position:absolute;
  left:16px; right:16px; bottom:6px;
  height:2px; border-radius:999px;
  background: var(--brand-grad);
  opacity:.95;
}

/* Menu items hover: gradient edge + subtle glow */
.nav-menu a:hover{
  background:
    linear-gradient(rgba(255,255,255,.06), rgba(255,255,255,.06)) padding-box,
    var(--brand-grad) border-box;
  border: 1px solid transparent;
  box-shadow: 0 8px 22px rgba(0,0,0,.35), 0 0 18px rgba(247,101,49,.18);
}

/* Active menu item: stronger (still clean) */
.nav-menu a[data-active="true"]{
  background:
    linear-gradient(rgba(255,255,255,.08), rgba(255,255,255,.08)) padding-box,
    var(--brand-grad) border-box;
  border: 1px solid transparent;
}
.nav-menu a[data-active="true"]::after{
  content:"";
  position:absolute;
  left:12px; right:12px; bottom:7px;
  height:2px; border-radius:999px;
  background: var(--brand-grad);
  opacity:.95;
}
/* ===== Page ===== */
.page{
  padding: 22px 0 56px;
  background:
    radial-gradient(900px 520px at 15% -10%, rgba(239,217,0,.10), transparent 60%),
    radial-gradient(860px 520px at 90% -20%, rgba(78,169,209,.08), transparent 55%),
    var(--black);
}

/* ===== Footer (identical) ===== */
.footer{
  margin-top:40px;
  padding:20px 0;
  border-top:1px solid rgba(255,255,255,.08);
  color:rgba(255,255,255,.55);
  font-size:12px;
  text-align:center;
}

/* Compatibility vars for inspector */
:root{
  --bg: var(--black);
  --line: rgba(255,255,255,.12);
}

h1{margin:0 0 10px;font-size:20px}
.meta{font-size:13px;opacity:.85;margin-bottom:14px}

.grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:16px;
}

/* ===== Gradient border card (bulletproof, no mask) ===== */
.card{
  border-radius:14px;
  border:1px solid transparent; /* Êû†„Çí‰Ωú„Çã„Åü„ÇÅ„Å´ÈÄèÊòéborder */
  background:
    linear-gradient(rgba(11,11,11,.92), rgba(11,11,11,.92)) padding-box, /* ‰∏≠Ë∫´ */
    linear-gradient(120deg,var(--yellow),var(--orange),var(--purple),var(--blue)) border-box; /* Êû† */
  box-shadow:
    0 0 0 1px rgba(255,255,255,.06) inset,
    0 10px 30px rgba(0,0,0,.55),
    0 4px 12px rgba(247,101,49,.25);
  overflow:hidden; /* „Éó„É¨„Éº„É§„Éº„Åå„ÅØ„ÅøÂá∫„Åó„Å¶„ÇÇÊû†„ÅÆÂ§ñ„Å´Âá∫„Å™„ÅÑ */
}

/* „ÇÇ„ÅÜ inner „Çí‰Ωø„Çè„Å™„Åè„Å¶ËâØ„ÅÑÔºàÊÆã„Åô„Å™„Çâ ‚ÄúÈÄèÊòé‚Äù „Å´Ôºâ */
.cardInner{
  background:transparent;
  border-radius:0;
  padding:14px;
  backdrop-filter: blur(6px);
}

/* „Éó„É¨„Éº„É§„Éº‰∏ã„ÅÆË¨é‰ΩôÁôΩÂØæÁ≠ñ */
.playerWrap{
  border-radius:12px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.12);
  background:#000;
  line-height:0;
}
.playerWrap .video-js{ display:block; }

.pill{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
  background:linear-gradient(135deg,#0072CE,#00AEEF,#6E3FF3);
}

.playerWrap{
  border-radius:12px;
  overflow:hidden;
  border:1px solid var(--line);
  background:#000;
}

.log{
  height:300px;
  overflow:auto;
  background:#070707;
  border:1px solid var(--line);
  border-radius:10px;
  padding:10px;
  font-family:monospace;
  font-size:12px;
  white-space:pre-wrap;
}

pre{
  background:#070707;
  border:1px solid var(--line);
  border-radius:10px;
  padding:10px;
  overflow:auto;
}
/* Player card should NOT stretch when the right card grows */
#playerCard{
  align-self: start;
  height: fit-content;
}

/* Safety: prevent grid items from stretching */
.grid{
  align-items: start;
}
/* ---- Event category tags (non-breaking add-on) ---- */
.logLine{
  display:flex;
  gap:8px;
  align-items:flex-start;
  padding:2px 0;
}

.tag{
  flex:0 0 auto;
  font-size:11px;
  font-weight:800;
  letter-spacing:.02em;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  user-select:none;
  white-space:nowrap;
}

.tag.play{   background: rgba(0,174,239,.18); border-color: rgba(0,174,239,.35); }
.tag.ad{  background: linear-gradient(135deg, #EFD900, #F76531); border-color: rgba(247,101,49,.55); color:#000; box-shadow:0 0 6px rgba(247,101,49,.35);}
.tag.error{  background: rgba(255,77,79,.18); border-color: rgba(255,77,79,.35); }
.tag.buffer{ background: rgba(170,108,126,.18); border-color: rgba(170,108,126,.35); }
.tag.info{   background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.14); }

.logMsg{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size:12px;
  line-height:1.55;
  white-space:pre-wrap;
  word-break:break-word;
  opacity:.95;
}

/* ===== Footer ===== */
.footer{
  position:relative;
  border-top: 1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(900px 420px at 15% 120%, rgba(239,217,0,.10), transparent 60%),
    radial-gradient(860px 420px at 85% 120%, rgba(78,169,209,.10), transparent 60%),
    linear-gradient(to top, rgba(255,255,255,.03), rgba(0,0,0,0) 45%),
    var(--black);
  overflow:hidden;
}

/* top accent line */
.footer::before{
  content:"";
  position:absolute;
  left:0; right:0; top:0;
  height:1px;
  background: linear-gradient(90deg, var(--yellow), var(--orange), var(--purple), var(--blue));
  opacity:.9;
}

/* subtle noise-ish sheen */
.footer::after{
  content:"";
  position:absolute;
  inset:-2px;
  background:
    radial-gradient(900px 520px at 50% 130%, rgba(255,255,255,.05), transparent 60%);
  pointer-events:none;
  opacity:.6;
}

.footer-inner{
  position:relative;
  z-index:1;
  padding: 40px 0 22px;
}

.footer-top{
  display:grid;
  grid-template-columns: 1.2fr 1fr;
  gap: 18px;
  align-items:start;
}

.footer-brand{
  display:flex;
  align-items:flex-start;
  gap:14px;
  text-align:left;
}

.footer-logo{
  width:34px;
  height:34px;
  object-fit:contain;
  flex:0 0 auto;
  opacity:.92;
}

.footer-brand h3{
  margin:0 0 4px 0;
  font-size:15px;
  font-weight:600;
  letter-spacing:.2px;
}

.footer-brand p{
  margin:0;
  font-size:13px;
  line-height:1.5;
  color:rgba(255,255,255,.65);
}

.footer-col h4{
  margin: 0 0 10px;
  font-size: 12px;
  letter-spacing:.35px;
  text-transform: uppercase;
  color: rgba(255,255,255,.78);
}

.footer-links{
  display:grid;
  grid-auto-flow: column;
  grid-template-rows: repeat(3, auto);
  gap: 8px 14px;
  align-content:start;
}

@media (max-width: 640px){
  .footer-links{
    grid-auto-flow: row;
    grid-template-rows: none;
  }
}

.footer-links a{
  color: rgba(255,255,255,.70);
  font-size: 13px;
  line-height:1.4;
  display:inline-flex;
  align-items:center;
  gap: 8px;
  width: fit-content;
  padding: 6px 8px;
  border-radius: 10px;
  transition: background .18s var(--ease), color .18s var(--ease), transform .18s var(--ease);
  outline:none;
}

.footer-links a:hover{
  color: rgba(255,255,255,.92);
  background: rgba(255,255,255,.06);
  transform: translateY(-1px);
}

.footer-links a:focus-visible{ box-shadow: var(--focus); }

.footer-links .hint{
  opacity:.75;
  font-size: 12px;
}

.footer-divider{
  margin: 22px 0 14px;
  height:1px;
  background: rgba(255,255,255,.10);
}

.footer-bottom{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  flex-wrap:wrap;
  color: rgba(255,255,255,.55);
  font-size: 12px;
}

.footer-badges{
  display:flex;
  align-items:center;
  gap: 8px;
  flex-wrap:wrap;
}

.footer-pill{
  display:inline-flex;
  align-items:center;
  gap: 8px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
  color: rgba(255,255,255,.70);
}

/* responsive */
@media (max-width: 980px){
  .footer-top{ grid-template-columns: 1fr 1fr; }
}
@media (max-width: 640px){
  .footer-inner{ padding: 34px 0 20px; }
  .footer-top{ grid-template-columns: 1fr; }
  .footer-bottom{ flex-direction:column; align-items:flex-start; }
}
</style>
</head>

<body>
  <header class="header" id="siteHeader">
    <div class="header-inner">
      <a class="brand" href="index.html">
        <img class="logo-img" src="https://solutions.brightcove.com/wmatsuo/Blogo.svg" alt="Brightcove Logo" />
        <div class="brand-name">
          <strong>BRIGHTCOVE</strong>
          <span>Onboarding Engagement Manager</span>
          <span>Implementation Gallery</span>
        </div>
      </a>
  
      <nav class="nav" aria-label="Primary">
        <a href="media.html" data-nav="media">Media</a>
        <a href="player.html" data-nav="player">Player</a>
      
        <!-- Catalog dropdown -->
        <div class="nav-dd" data-nav-group="catalog">
          <button class="nav-dd-btn" type="button" aria-haspopup="menu" aria-expanded="false">
            Catalog
            <span class="chev" aria-hidden="true"></span>
          </button>
          <div class="nav-menu" role="menu" aria-label="Catalog menu">
            <a role="menuitem" href="api.html" data-nav="api">Catalog API</a>
            <a role="menuitem" href="playlist.html" data-nav="playlist">Playlist</a>
            <a role="menuitem" href="grid.html" data-nav="grid">Grid</a>
          </div>
        </div>
      
        <!-- Advertising dropdown -->
        <div class="nav-dd" data-nav-group="advertising">
          <button class="nav-dd-btn" type="button" aria-haspopup="menu" aria-expanded="false">
            Advertising
            <span class="chev" aria-hidden="true"></span>
          </button>
          <div class="nav-menu" role="menu" aria-label="Advertising menu">
            <a role="menuitem" href="ad.html" data-nav="csai">CSAI</a>
            <a role="menuitem" href="ssai.html" data-nav="ssai">SSAI</a>
          </div>
        </div>
      
        <a href="ga.html" data-nav="ga">Google Analytics</a>
      </nav>
    </div>
  </header>

<main class="page">
  <div class="container">

<h1>CSAI Advertising Inspector</h1>
<div class="meta">
    Visualizes ad events and playback state for a Client-Side Ad Insertion (IMA) player.
    </div>

<div class="grid">

  <!-- Player -->
  <div class="card" id="playerCard">
    <div class="cardInner">
      <div style="display:flex;justify-content:space-between;margin-bottom:10px">
        <div>CSAI Player</div>
        <span class="pill" id="statePill">idle</span>
      </div>

      <div class="playerWrap">
        <!-- üî¥ „ÅÇ„Å™„Åü„ÅÆCSAI„Éó„É¨„Éº„É§„ÉºÂüã„ÇÅËæº„Åø -->
        <video-js
          id="bcPlayer"
          data-account="6243204265001"
          data-player="FK76SpFoAP"
          data-embed="default"
          data-video-id="1849994462098665240"
          controls
          playsinline
          class="video-js vjs-fluid vjs-16-9">
        </video-js>
      </div>

    </div>
  </div>

  <!-- Inspector -->
  <div class="card">
    <div class="cardInner">

        <div style="margin-bottom:8px;display:flex;align-items:center;gap:8px">
            <div>Event Log</div>
            <span class="pill dim">browser runtime</span>
            <span style="opacity:.65;font-size:12px">
              Player &amp; ad events emitted in the browser (video.js / IMA)
            </span>
          </div>
          
          <!-- ‚òÖ„Åì„Çå„Åå„É≠„Ç∞Êú¨‰ΩìÔºöÊ∂à„Åï„Å™„ÅÑ„ÅßÔºÅ -->
          <div class="log" id="log"></div>

          <div style="margin:12px 0 6px;display:flex;align-items:center;gap:8px">
            <div>Brightcove Analytics</div>
            <span class="pill dim">metrics payload</span>
            <span style="opacity:.65;font-size:12px">
              Outbound tracker events sent to metrics.brightcove.com (best-effort capture)
            </span>
          </div>
          
          <pre id="metricsDebug">{}</pre>

    </div>
  </div>

</div>
</div>
</main>

<!-- Brightcove Player -->
<script src="https://players.brightcove.net/6243204265001/FK76SpFoAP_default/index.min.js"></script>

<script>
    /* =========================================================
       CSAI Advertising Inspector (static embed)
       - Player runtime events -> #log
       - Brightcove Analytics tracker -> #metricsDebug (SUMMARIZED)
       ========================================================= */
    
    const $ = (sel) => document.querySelector(sel);
    const pretty = (o) => JSON.stringify(o, null, 2);
    
    const ui = {
      logEl: $("#log"),
      metricsEl: $("#metricsDebug"),
      statePill: $("#statePill")
    };
    
    function setPill(text){ if (ui.statePill) ui.statePill.textContent = text; }
    function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function logEvent(type, message){
  const el = document.getElementById("log"); // „ÅÇ„Å™„Åü„ÅÆ„Éö„Éº„Ç∏„ÅØ id="log"
  if (!el) return;

  const ts = new Date().toISOString().slice(11,19);
  const t = (type || "info").toLowerCase();
  const safeMsg = escapeHtml(message);

  // ‰∏ä„Å´Á©ç„ÇÄÔºà‰ªä„Åæ„ÅßÈÄö„ÇäÔºâ
  el.innerHTML =
    `<div class="logLine">` +
      `<span class="tag ${t}">${escapeHtml(t)}</span>` +
      `<span class="logMsg">[${ts}] ${safeMsg}</span>` +
    `</div>` + el.innerHTML;
}

// ‰∫íÊèõ: Êó¢Â≠ò„ÅÆ log("...") Âëº„Å≥Âá∫„Åó„ÇíÂ£ä„Åï„Å™„ÅÑ
function log(line){
  logEvent("info", line);
}
    function setMetrics(obj){ if (ui.metricsEl) ui.metricsEl.textContent = pretty(obj); }
    
    // =====================
    // Metrics settings
    // =====================
    const METRICS_EVENT_ALLOWLIST = new Set([
      "play_request",
      "video_view",
      "video_engagement",
      "ad_begin",
      "ad_complete",
      "ad_mode_complete",
      "ad_error",
      "ad_request",
      "ad_response"
    ]);
    const METRICS_SHOW_ALL_EVENTS = false;
    const METRICS_MAX = 60;
    
    // =====================
    // Metrics capture state
    // =====================
    const metricsState = {
      installedAt: new Date().toISOString(),
      summaryEvents: []
    };
    
    function isMetricsUrl(url){
      return typeof url === "string" && (
        url.includes("metrics.brightcove.com") ||
        url.includes("metric.brightcove.com")
      );
    }
    
    function parseQueryFromUrl(url){
      try {
        const u = new URL(url, location.href);
        const obj = {};
        u.searchParams.forEach((v,k) => { obj[k] = v; });
        return obj;
      } catch {
        return null;
      }
    }
    
    function parseBodyString(text){
      const t = (text || "").trim();
      if (!t) return { raw: "" };
    
      if (t.startsWith("{") || t.startsWith("[")) {
        try { return { json: JSON.parse(t) }; } catch {}
      }
    
      try {
        const params = new URLSearchParams(t);
        const obj = {};
        let hasAny = false;
        for (const [k,v] of params.entries()) { obj[k] = v; hasAny = true; }
        if (hasAny) return { params: obj };
      } catch {}
    
      return { raw: t };
    }
    
    async function beaconToText(data){
      try{
        if (typeof data === "string") return data;
        if (data instanceof Blob) return await data.text();
        if (data instanceof ArrayBuffer) return new TextDecoder().decode(data);
        if (ArrayBuffer.isView(data)) return new TextDecoder().decode(data.buffer);
      } catch {}
      return "";
    }
    
    function toNumber(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }
    
    function epochMsToIso(ms){
      const n = toNumber(ms);
      if (!n) return null;
      try { return new Date(n).toISOString(); } catch { return null; }
    }
    
    function pick(obj, keys){
      const out = {};
      keys.forEach(k => { if (obj && obj[k] !== undefined && obj[k] !== "") out[k] = obj[k]; });
      return out;
    }
    
    function summarizeTrackerQuery(q){
      if (!q) return null;
    
      const ev = q.event || "(unknown)";
      if (!METRICS_SHOW_ALL_EVENTS && !METRICS_EVENT_ALLOWLIST.has(ev)) return null;
    
      const base = {
        ts: epochMsToIso(q.time) || null,
        event: ev,
        account: q.account,
        session: q.session,
        video: q.video,
        player_name: q.player_name,
        delivery_type: q.delivery_type,
        media_type: q.media_type,
        autoplay: q.autoplay,
        ads_enabled: q.ads_enabled,
        seq: q.seq
      };
    
      const ad = pick(q, [
        "ads_pod_type",
        "ads_pod_time_offset",
        "ads_ad_system",
        "ads_ad_duration",
        "ads_ad_title",
        "ads_ad_creative_id",
        "ads_ad_start_ms",
        "ads_ad_index",
        "ads_pod_ad_count"
      ]);
    
      let qos = null;
      if (ev === "video_engagement") {
        qos = pick(q, [
          "measured_bps",
          "media_bytes_transferred",
          "media_requests",
          "media_transfer_duration",
          "media_seconds_loaded",
          "forward_buffer_seconds",
          "qos.frames.dropped",
          "qos.frames.total",
          "qos.frames.corrupted",
          "range",
          "qos.derived_range"
        ]);
      }
    
      const out = { ...base };
      if (Object.keys(ad).length) out.ad = ad;
      if (qos && Object.keys(qos).length) out.qos = qos;
    
      return out;
    }
    
    function renderMetrics(){
      setMetrics(metricsState.summaryEvents);
    }
    
    function pushMetricsSummary(summary){
      if (!summary) return;
      metricsState.summaryEvents.unshift(summary);
      if (metricsState.summaryEvents.length > METRICS_MAX) metricsState.summaryEvents.length = METRICS_MAX;
      renderMetrics();
    }
    
    function handleCapturedMetrics({ transport, url, bodyText }) {
      const qUrl = parseQueryFromUrl(url);
      const parsedBody = bodyText ? parseBodyString(bodyText) : null;
      const qBody = (parsedBody && parsedBody.params) ? parsedBody.params : null;
      const merged = { ...(qUrl || {}), ...(qBody || {}) };
    
      const summary = summarizeTrackerQuery(merged);
      pushMetricsSummary(summary);
    }
    
    // =====================
    // Install metrics taps
    // =====================
    function installMetricsTap(){
      metricsState.summaryEvents = [];
      renderMetrics();
      log("Metrics tap installed (summary mode).");
    
      // 1) sendBeacon
      if (navigator.sendBeacon) {
        const orig = navigator.sendBeacon.bind(navigator);
        navigator.sendBeacon = function(url, data){
          if (isMetricsUrl(url)) {
            beaconToText(data).then((txt) => {
              handleCapturedMetrics({ transport: "sendBeacon", url: String(url), bodyText: txt });
            });
          }
          return orig(url, data);
        };
      }
    
      // 2) fetch
      if (window.fetch) {
        const origFetch = window.fetch.bind(window);
        window.fetch = async function(input, init){
          const url = (typeof input === "string") ? input : (input && input.url) ? input.url : "";
          if (isMetricsUrl(url)) {
            try {
              const body = init?.body;
              const txt = typeof body === "string" ? body : "";
              handleCapturedMetrics({ transport: "fetch", url: String(url), bodyText: txt });
            } catch {}
          }
          return origFetch(input, init);
        };
      }
    
      // 3) XHR
      const XHROpen = XMLHttpRequest.prototype.open;
      const XHRSend = XMLHttpRequest.prototype.send;
    
      XMLHttpRequest.prototype.open = function(method, url){
        this.__bc_metrics_url = url;
        return XHROpen.apply(this, arguments);
      };
      XMLHttpRequest.prototype.send = function(body){
        if (isMetricsUrl(this.__bc_metrics_url)) {
          try {
            const txt = typeof body === "string" ? body : "";
            handleCapturedMetrics({ transport: "xhr", url: String(this.__bc_metrics_url), bodyText: txt });
          } catch {}
        }
        return XHRSend.apply(this, arguments);
      };
    
      // 4) Image pixel: new Image().src / img.src
      const imgDesc = Object.getOwnPropertyDescriptor(Image.prototype, "src");
      if (imgDesc && imgDesc.set) {
        Object.defineProperty(Image.prototype, "src", {
          get: imgDesc.get,
          set: function(url){
            try{
              const u = String(url);
              if (isMetricsUrl(u)) handleCapturedMetrics({ transport: "img.src", url: u, bodyText: "" });
            } catch {}
            return imgDesc.set.call(this, url);
          }
        });
      }
    
      // 5) <img src=...> via setAttribute
      const origSetAttr = Element.prototype.setAttribute;
      Element.prototype.setAttribute = function(name, value){
        try{
          if (this && this.tagName === "IMG" && name.toLowerCase() === "src") {
            const u = String(value);
            if (isMetricsUrl(u)) handleCapturedMetrics({ transport: "img.setAttribute", url: u, bodyText: "" });
          }
        } catch {}
        return origSetAttr.apply(this, arguments);
      };
    }
    
    // =====================
    // Player event wiring
    // =====================
    function wirePlayer(player){
  const vjsEvents = [
    "loadstart","loadedmetadata","loadeddata","canplay","canplaythrough",
    "play","playing","pause","ended","waiting","stalled","error"
  ];

  // „Åñ„Å£„Åè„ÇäÂàÜÈ°û
  const classifyVjs = (ev) => {
    if (ev === "error") return "error";
    if (["play","playing","pause","ended"].includes(ev)) return "play";
    if (["waiting","stalled"].includes(ev)) return "buffer";
    return "info";
  };

  vjsEvents.forEach(ev => player.on(ev, () => {
    if (ev === "error") {
      const e = player.error?.() || {};
      logEvent("error", `event: error code=${e.code || ""} msg=${e.message || ""}`);
      setPill("error");
      return;
    }
    if (ev === "play") {
      logEvent("play", `event: play (src=${player.currentSrc?.() || ""})`);
      return;
    }
    logEvent(classifyVjs(ev), `event: ${ev}`);
  }));

  const adEvents = [
    "ads-request","ads-load","ads-ad-started","ads-ad-ended","ads-ad-skipped",
    "ads-first-quartile","ads-midpoint","ads-third-quartile","ads-complete",
    "ads-all-ads-completed","adserror"
  ];

  adEvents.forEach(ev => player.on(ev, () => {
    if (ev === "adserror") {
      logEvent("error", `event: ${ev}`);
      setPill("error");
      return;
    }
    logEvent("ad", `event: ${ev}`);
  }));

  setPill("ready");
  logEvent("info", "Player ready");
}
    
    // =====================
    // Boot
    // =====================
    (function main(){
      setPill("loading");
      installMetricsTap();
      renderMetrics();
    
      if (typeof window.videojs !== "function") {
        setPill("failed");
        log("ERROR: videojs not found");
        return;
      }
    
      const player = window.videojs.getPlayer("bcPlayer");
      if (!player) {
        setPill("failed");
        log("ERROR: getPlayer('bcPlayer') returned null");
        return;
      }
    
      player.ready(() => wirePlayer(player));
    })();
    </script>
    <script>
      const header = document.getElementById('siteHeader');
      if (header) {
        const onScroll = () => header.classList.toggle('is-scrolled', window.scrollY > 6);
        onScroll();
        window.addEventListener('scroll', onScroll, { passive: true });
      }
      </script>
      <script>
        (() => {
          // === Dropdown open/close ===
          const dds = Array.from(document.querySelectorAll('.nav-dd'));
          const closeAll = () => dds.forEach(dd => {
            dd.dataset.open = "false";
            const btn = dd.querySelector('.nav-dd-btn');
            if (btn) btn.setAttribute('aria-expanded', 'false');
          });
        
          const openOne = (dd) => {
            closeAll();
            dd.dataset.open = "true";
            const btn = dd.querySelector('.nav-dd-btn');
            if (btn) btn.setAttribute('aria-expanded', 'true');
          };
        
          dds.forEach(dd => {
            const btn = dd.querySelector('.nav-dd-btn');
            if (!btn) return;
        
            dd.dataset.open = "false";
        
            btn.addEventListener('click', (e) => {
              e.preventDefault();
              const isOpen = dd.dataset.open === "true";
              if (isOpen) closeAll();
              else openOne(dd);
            });
          });
        
          document.addEventListener('click', (e) => {
            const inside = e.target.closest('.nav-dd');
            if (!inside) closeAll();
          });
        
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeAll();
          });
        
          // === Active state (by pathname) ===
          const path = (location.pathname.split('/').pop() || '').toLowerCase();
        
          const setActive = (selector) => {
            const el = document.querySelector(selector);
            if (el) el.dataset.active = "true";
          };
        
          // reset all active markers
          document.querySelectorAll('.nav [data-active]').forEach(a => a.removeAttribute('data-active'));
          document.querySelectorAll('.nav-dd').forEach(dd => dd.removeAttribute('data-active'));
        
          // map pages -> nav keys
          const pageToNav = new Map([
            ['media.html', 'media'],
            ['player.html', 'player'],
            ['api.html', 'api'],
            ['playlist.html', 'playlist'],
            ['grid.html', 'grid'],
            ['ad.html', 'csai'],
            ['ssai.html', 'ssai'],
            ['ga.html', 'ga'],
          ]);
        
          const key = pageToNav.get(path);
          if (key) {
            // direct links
            const direct = document.querySelector(`.nav > a[data-nav="${key}"]`);
            if (direct) direct.dataset.active = "true";
        
            // dropdown items
            const item = document.querySelector(`.nav-menu a[data-nav="${key}"]`);
            if (item) {
              item.dataset.active = "true";
              const group = item.closest('.nav-dd');
              if (group) group.dataset.active = "true"; // parent highlight
            }
          } else {
            // optional: default when landing page
            // if (path === '' || path === 'index.html') { ... }
          }
        })();
        </script>

<footer class="footer" aria-label="Site footer">
  <div class="container footer-inner">
    <div class="footer-top">
      <div class="footer-brand">
        <img class="footer-logo" src="https://solutions.brightcove.com/wmatsuo/Blogo.svg" alt="" aria-hidden="true">
        <div>
          <h3>Onboarding Engagement Manager</h3>
          <p>
            A lightweight Brightcove onboarding/demo gallery‚Äîplayer patterns, catalog surfaces, and advertising inspectors.
          </p>
        </div>
      </div>

      <div class="footer-col">
        <h4>Explore</h4>
        <nav class="footer-links" aria-label="Footer navigation">
          <a href="index.html"><span aria-hidden="true">‚Üó</span> Home</a>
          <a href="media.html"><span aria-hidden="true">‚Üó</span> Media</a>
          <a href="playershow.html"><span aria-hidden="true">‚Üó</span> Player showcase</a>
          <a href="api.html"><span aria-hidden="true">‚Üó</span> Catalog API</a>
          <a href="playlist.html"><span aria-hidden="true">‚Üó</span> Playlist</a>
          <a href="grid.html"><span aria-hidden="true">‚Üó</span> Grid</a>
          <a href="ad.html"><span aria-hidden="true">‚Üó</span> Advertising (CSAI)</a>
          <a href="ssai.html"><span aria-hidden="true">‚Üó</span> Advertising (SSAI)</a>
          <a href="ga4_gallery.html"><span aria-hidden="true">‚Üó</span> Google Analytics</a>
        </nav>
      </div>
    </div>

    <div class="footer-divider" role="separator"></div>

    <div class="footer-bottom">
      <div>¬© <span id="footerYear"></span> Brightcove ‚Ä¢ Waku Matsuo</div>

      <div class="footer-badges" aria-label="Badges">
        <span class="footer-pill">Docs-aligned</span>
        <span class="footer-pill">Implementation-first</span>
        <span class="footer-pill">Brightcove Player</span>
      </div>
    </div>
  </div>
</footer>

<script>
(() => {
  const y = document.getElementById('footerYear');
  if (y) y.textContent = String(new Date().getFullYear());
})();
</script>
</body>
</html>
